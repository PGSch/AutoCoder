name: AutoCoder Bot

permissions:
  contents: write
  pull-requests: write

on:
  issues:
    types: [opened, reopened, labeled]

jobs:
  generate_code:
    runs-on: ubuntu-latest

    if: contains(github.event.issue.labels.*.name, 'autocoder-bot')

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPOSITORY: ${{ github.repository }}
      ISSUE_NUMBER: ${{ github.event.issue.number }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set permissions for script.sh
        run: chmod +x ./scripts/script.sh

      - name: Run script.sh
        id: generate_code
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: date +%s > testing.txt
#        run: ./scripts/script.sh $GITHUB_TOKEN $REPOSITORY $ISSUE_NUMBER $OPENAI_API_KEY

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ env.GITHUB_TOKEN }}
          commit-message: Initialize code package created by gpt
          committer: autocoder-bot <actions@github.com>
          author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>
          signoff: false
          branch: autocoder-branch-${{ env.ISSUE_NUMBER }}
          base: main
          delete-branch: false
          title: 'PR to issue ${{ env.ISSUE_NUMBER }}'
          body: |
            Update report
            - Updated with *today's* date
            - Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
          labels: autocoder-bot
          draft: false
#      - name: Upload generated files as artifacts
#        uses: actions/upload-artifact@v4
#        with:
#          name: autocoder-artifact
#          path: ./autocoder-bot
#          if-no-files-found: error
#          retention-days: 1

#      - name: Download Artifact
#        uses: actions/download-artifact@v4
#        with:
#          name: autocoder-artifact
#          path: ./autocoder-artifact
#
#      - name: List Artifact Contents
#        run: |
#          echo "Listing contents of autocoder-artifact:"
#          ls -R ./autocoder-artifact

#       Uncomment the following steps if you need to commit the generated code to the repository
#       - name: Configure Git
#         run: |
#           git config --local user.name "GitHub Actions Bot"
#           git config --local user.email "actions@github.com"
#
#       - name: Add changes to the repo
#         run: |
#           git add ./autocoder-bot
#           git commit -m "Add generated code from AutoCoder Bot"
#
#       - name: Push changes
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         run: |
#           git push origin HEAD